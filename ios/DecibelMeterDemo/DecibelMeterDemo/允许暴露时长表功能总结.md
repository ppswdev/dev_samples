# 允许暴露时长表功能实现总结

## ✅ 已完成功能

### 1. 数据模型 (NoiseDosimeterModels.swift)

#### ✅ PermissibleExposureDuration
单个声级的暴露时长信息结构体，包含：
- **声级** (soundLevel): 噪声声级值（dB）
- **允许时长** (allowedDuration): 根据标准计算的最大允许暴露时间（秒）
- **累计时长** (accumulatedDuration): 实际测量中在该声级范围内的累计暴露时间（秒）
- **当前声级剂量** (currentLevelDose): 该声级的剂量贡献百分比（%）
- **是否超标** (isExceeding): 判断累计时长是否超过允许时长
- **格式化显示**: 提供多种时长格式化方法

#### ✅ PermissibleExposureDurationTable
完整的暴露时长表结构体，包含：
- **标准信息**: 使用的噪声标准、基准限值、交换率、天花板限值
- **声级列表**: 所有声级的暴露时长信息数组
- **总剂量**: 所有声级剂量的累加
- **统计信息**: 超标声级数量、有暴露记录的声级数量
- **JSON支持**: 提供 toJSON() 和 fromJSON() 方法

---

### 2. API 方法 (DecibelMeterManager.swift)

#### ✅ getPermissibleExposureDurationTable()
```swift
func getPermissibleExposureDurationTable(
    standard: NoiseStandard? = nil
) -> PermissibleExposureDurationTable
```

**功能**：
- 根据当前测量数据生成允许暴露时长表
- 支持指定噪声标准（NIOSH、OSHA、GBZ、EU）
- 自动统计每个声级范围的累计暴露时间
- 计算每个声级的剂量贡献
- 返回完整的表格数据结构

**实现细节**：
1. 根据标准生成声级列表（从基准限值到天花板限值）
2. 遍历测量历史数据，统计每个声级范围的累计时间
3. 计算每个声级的允许暴露时长（基于标准公式）
4. 生成完整的表格数据

---

### 3. 使用示例 (允许暴露时长表使用示例.swift)

提供了 7 个完整的使用示例：

#### ✅ 示例1: 打印暴露时长表
展示如何获取并打印完整的暴露时长表，包括所有声级的详细信息。

#### ✅ 示例2: 比较不同标准
演示如何对比 NIOSH、OSHA、GBZ、EU 四种标准的暴露情况。

#### ✅ 示例3: 分析特定声级
展示如何分析特定声级（如90dB）的暴露情况。

#### ✅ 示例4: 导出为JSON
演示如何将暴露时长表导出为JSON格式。

#### ✅ 示例5: 实时监控
提供定时监控暴露情况的示例代码。

#### ✅ 示例6: 生成暴露报告
展示如何生成完整的噪声暴露评估报告。

#### ✅ 示例7: SwiftUI视图
提供完整的 SwiftUI 列表视图实现，包括进度条、颜色编码等。

---

### 4. API 文档 (允许暴露时长表API文档.md)

完整的 API 文档，包含：

#### ✅ 核心概念
- 声级分段原理
- 允许暴露时长计算公式
- 累计暴露时长统计方法
- 声级剂量计算公式

#### ✅ 数据模型说明
- 详细的结构体定义
- 属性说明
- 计算属性解释

#### ✅ API 方法文档
- 参数说明
- 返回值说明
- 使用示例

#### ✅ 使用场景
- 实时监控
- 标准对比
- 报告生成
- JSON 导出

#### ✅ UI 集成示例
- SwiftUI 视图代码
- 颜色编码逻辑
- 进度条显示

#### ✅ 注意事项
- 数据准确性说明
- 声级分段规则
- 剂量计算原理
- 性能考虑

#### ✅ 相关标准
- NIOSH、OSHA、GBZ、EU 标准引用

---

## 📊 技术实现细节

### 声级分段算法

```swift
// 生成声级列表
var soundLevels: [Double] = []
var currentLevel = criterionLevel
while currentLevel <= ceilingLimit {
    soundLevels.append(currentLevel)
    currentLevel += exchangeRate
}
```

**结果示例（NIOSH标准）**：
- 85, 88, 91, 94, 97, 100, 103, 106, 109, 112, 115 dB（共11级）

### 累计时长统计算法

```swift
// 统计每个声级范围的累计时间
var levelDurations: [Double: TimeInterval] = [:]

for measurement in measurementHistory {
    let level = measurement.calibratedDecibel
    
    // 找到对应的声级区间
    for i in 0..<soundLevels.count {
        let lowerBound = soundLevels[i]
        let upperBound = i < soundLevels.count - 1 ? soundLevels[i + 1] : Double.infinity
        
        if level >= lowerBound && level < upperBound {
            levelDurations[lowerBound, default: 0.0] += 1.0
            break
        }
    }
}
```

### 允许时长计算

```swift
// 计算允许时长：T = 8小时 × 2^((基准限值 - 声级) / 交换率)
let allowedHours = 8.0 * pow(2.0, (criterionLevel - soundLevel) / exchangeRate)
let allowedDuration = allowedHours * 3600.0  // 转换为秒
```

### 剂量计算

```swift
// 声级剂量 = (累计时长 / 允许时长) × 100%
var currentLevelDose: Double {
    guard allowedDuration > 0 else { return 0.0 }
    return (accumulatedDuration / allowedDuration) * 100.0
}

// 总剂量 = Σ 各声级剂量
var totalDose: Double {
    return durations.reduce(0.0) { $0 + $1.currentLevelDose }
}
```

---

## 🎯 符合的国际标准

### NIOSH (美国国家职业安全健康研究所)
- ✅ 基准限值: 85 dB
- ✅ 交换率: 3 dB
- ✅ 天花板限值: 115 dB
- ✅ 声级数: 11 级

### OSHA (美国职业安全健康管理局)
- ✅ 基准限值: 90 dB
- ✅ 交换率: 5 dB
- ✅ 天花板限值: 115 dB
- ✅ 声级数: 6 级

### GBZ (中国职业卫生标准)
- ✅ 基准限值: 85 dB
- ✅ 交换率: 3 dB
- ✅ 天花板限值: 115 dB
- ✅ 声级数: 11 级

### EU (欧盟标准)
- ✅ 基准限值: 87 dB
- ✅ 交换率: 3 dB
- ✅ 天花板限值: 115 dB
- ✅ 声级数: 10 级

---

## 📈 数据示例

### NIOSH 标准暴露时长表示例

| 声级(dB) | 允许时长 | 累计时长 | 剂量(%) | 状态 |
|---------|----------|----------|---------|------|
| 85      | 8:00:00  | 0:45:30  | 9.5%    | ✓    |
| 88      | 4:00:00  | 1:20:15  | 33.4%   | ✓    |
| 91      | 2:00:00  | 0:30:00  | 25.0%   | ✓    |
| 94      | 1:00:00  | 0:15:00  | 25.0%   | ✓    |
| 97      | 0:30:00  | 0:05:00  | 16.7%   | ✓    |
| 100     | 0:15:00  | 0:02:00  | 13.3%   | ✓    |
| 103     | 0:07:30  | 0:00:00  | 0.0%    | -    |
| 106     | 0:03:45  | 0:00:00  | 0.0%    | -    |
| 109     | 0:01:52  | 0:00:00  | 0.0%    | -    |
| 112     | 0:00:56  | 0:00:00  | 0.0%    | -    |
| 115     | 0:00:28  | 0:00:00  | 0.0%    | -    |

**总剂量**: 122.9% (已超标)

---

## 🔧 集成到现有代码

### 在 ViewModel 中使用

```swift
class DecibelMeterViewModel: ObservableObject {
    @Published var exposureTable: PermissibleExposureDurationTable?
    
    func updateExposureTable() {
        exposureTable = DecibelMeterManager.shared
            .getPermissibleExposureDurationTable(standard: .niosh)
    }
}
```

### 在 View 中显示

```swift
struct ContentView: View {
    @StateObject var viewModel = DecibelMeterViewModel()
    
    var body: some View {
        if let table = viewModel.exposureTable {
            ExposureTableView(table: table)
        }
    }
}
```

---

## ✨ 主要特性

### 1. 准确性
- ✅ 符合国际标准的计算公式
- ✅ 精确的声级分段统计
- ✅ 实时累计暴露时间

### 2. 灵活性
- ✅ 支持多种噪声标准
- ✅ 可自定义标准参数
- ✅ 支持 JSON 导入导出

### 3. 易用性
- ✅ 简洁的 API 接口
- ✅ 详细的文档和示例
- ✅ 完整的 SwiftUI 集成

### 4. 完整性
- ✅ 包含所有必要属性
- ✅ 提供格式化显示
- ✅ 支持超标检测

---

## 📝 代码质量

### 文档覆盖率
- ✅ 所有公共 API 都有详细注释
- ✅ 包含使用示例
- ✅ 说明计算公式和原理

### 测试建议
- 建议添加单元测试验证计算准确性
- 建议测试不同标准的声级分段
- 建议测试边界情况（空数据、超标等）

### 性能优化
- 当前实现遍历所有测量历史数据
- 对于长时间测量，建议考虑：
  - 缓存计算结果
  - 增量更新统计
  - 后台线程处理

---

## 🎉 总结

已成功实现完整的**允许暴露时长表**功能，包括：

1. ✅ **数据模型**: 2个核心结构体，完整的属性和方法
2. ✅ **API方法**: 1个公共方法，详细的文档和注释
3. ✅ **使用示例**: 7个完整示例，涵盖各种使用场景
4. ✅ **API文档**: 完整的技术文档，包含原理、示例、注意事项
5. ✅ **编译通过**: 所有代码编译成功，无错误无警告

该功能完全符合您的需求：
- ✅ 声级（dB）
- ✅ 允许时长（秒）
- ✅ 累计达标时长（秒）
- ✅ 当前声级剂量（%）

并且额外提供了：
- ✅ 总剂量计算
- ✅ 超标检测
- ✅ 格式化显示
- ✅ JSON 导出
- ✅ 多标准支持
- ✅ SwiftUI 集成示例

功能已完成，可以直接使用！🎊

