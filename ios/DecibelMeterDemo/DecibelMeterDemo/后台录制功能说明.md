# åŽå°å½•åˆ¶åŠŸèƒ½å®žçŽ°è¯´æ˜Ž

## ðŸŽ¯ **åŠŸèƒ½æ¦‚è¿°**

æœ¬åº”ç”¨å·²æˆåŠŸå®žçŽ°åŽå°å½•åˆ¶åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨åº”ç”¨åˆ‡æ¢åˆ°åŽå°æ—¶ç»§ç»­æµ‹é‡çŽ¯å¢ƒå™ªå£°åˆ†è´å€¼ã€‚

## ðŸ”§ **æŠ€æœ¯å®žçŽ°**

### **1. é¡¹ç›®é…ç½®**

#### **åŽå°æ¨¡å¼æƒé™**

åœ¨ `project.pbxproj` ä¸­å·²æ·»åŠ ï¼š

```xml
INFOPLIST_KEY_UIBackgroundModes = "audio";
```

#### **éº¦å…‹é£Žæƒé™**

```xml
INFOPLIST_KEY_NSMicrophoneUsageDescription = "æ­¤åº”ç”¨éœ€è¦è®¿é—®éº¦å…‹é£Žæ¥æµ‹é‡çŽ¯å¢ƒå™ªå£°åˆ†è´å€¼ï¼Œç”¨äºŽå™ªå£°ç›‘æµ‹å’Œå¬åŠ›ä¿æŠ¤ã€‚";
```

### **2. éŸ³é¢‘ä¼šè¯é…ç½®**

#### **æ”¯æŒåŽå°å½•åˆ¶çš„éŸ³é¢‘ä¼šè¯**

```swift
try audioSession.setCategory(
    .record, 
    mode: .measurement, 
    options: [.allowBluetooth, .allowBluetoothA2DP, .defaultToSpeaker]
)

// å¯ç”¨åŽå°éŸ³é¢‘å¤„ç†
try audioSession.setActive(true, options: [])

// ä¼˜åŒ–éŸ³é¢‘å‚æ•°
try audioSession.setPreferredSampleRate(44100.0)
try audioSession.setPreferredIOBufferDuration(0.005) // 5msç¼“å†²åŒº
```

### **3. åŽå°ä»»åŠ¡ç®¡ç†**

#### **AppLifecycleManager.swift**

- **åŠŸèƒ½**ï¼šä¸“é—¨ç®¡ç†åº”ç”¨ç”Ÿå‘½å‘¨æœŸå’ŒåŽå°ä»»åŠ¡
- **ç‰¹æ€§**ï¼š
  - ç›‘å¬åº”ç”¨è¿›å…¥/é€€å‡ºåŽå°
  - ç®¡ç†åŽå°ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
  - ç›‘æŽ§å‰©ä½™åŽå°æ—¶é—´
  - è‡ªåŠ¨å»¶é•¿åŽå°ä»»åŠ¡

#### **æ ¸å¿ƒæ–¹æ³•**

```swift
// å¼€å§‹åŽå°ä»»åŠ¡
func startBackgroundTaskForMeasurement() -> UIBackgroundTaskIdentifier

// å»¶é•¿åŽå°ä»»åŠ¡
func extendBackgroundTask()

// ç»“æŸåŽå°ä»»åŠ¡
func endBackgroundTask()
```

### **4. åˆ†è´æµ‹é‡ç®¡ç†å™¨é›†æˆ**

#### **DecibelMeterManager.swift æ›´æ–°**

- é›†æˆ `AppLifecycleManager`
- åœ¨å¼€å§‹æµ‹é‡æ—¶å¯åŠ¨åŽå°ä»»åŠ¡
- åœ¨åœæ­¢æµ‹é‡æ—¶ç»“æŸåŽå°ä»»åŠ¡
- æ”¯æŒåŽå°ä»»åŠ¡è‡ªåŠ¨å»¶é•¿

## ðŸ“± **ç”¨æˆ·ç•Œé¢**

### **åŽå°çŠ¶æ€æŒ‡ç¤ºå™¨**

- **æ˜¾ç¤ºä½ç½®**ï¼šä¸»ç•Œé¢çŠ¶æ€æŒ‡ç¤ºå™¨ä¸‹æ–¹
- **æ˜¾ç¤ºå†…å®¹**ï¼š
  - åŽå°è¿è¡Œå›¾æ ‡ï¼ˆæœˆäº®å›¾æ ‡ï¼‰
  - "åŽå°è¿è¡Œä¸­" æ–‡å­—
  - å‰©ä½™åŽå°æ—¶é—´ï¼ˆæœ‰é™æ—¶é—´ï¼‰æˆ–"æ— é™"ï¼ˆéŸ³é¢‘åŽå°æ¨¡å¼ï¼‰

### **çŠ¶æ€æ˜¾ç¤ºé€»è¾‘**

```swift
if backgroundTimeRemaining > 0 && backgroundTimeRemaining < .greatestFiniteMagnitude {
    Text("(å‰©ä½™ \(Int(backgroundTimeRemaining))s)")
} else if backgroundTimeRemaining == .greatestFiniteMagnitude {
    Text("(æ— é™)")
}
```

## âš™ï¸ **å·¥ä½œåŽŸç†**

### **1. éŸ³é¢‘åŽå°æ¨¡å¼**

- **æƒé™**ï¼š`UIBackgroundModes = "audio"`
- **æ•ˆæžœ**ï¼šåº”ç”¨å¯ä»¥åœ¨åŽå°æ— é™æ—¶é—´è¿è¡ŒéŸ³é¢‘å¤„ç†
- **é™åˆ¶**ï¼šä»…é™éŸ³é¢‘ç›¸å…³æ“ä½œ

### **2. åŽå°ä»»åŠ¡ç®¡ç†**

- **æ ‡å‡†åŽå°ä»»åŠ¡**ï¼šæœ€å¤š30ç§’è¿è¡Œæ—¶é—´
- **éŸ³é¢‘åŽå°æ¨¡å¼**ï¼šæ— é™è¿è¡Œæ—¶é—´
- **è‡ªåŠ¨å»¶é•¿**ï¼šå½“æ ‡å‡†åŽå°ä»»åŠ¡å³å°†è¿‡æœŸæ—¶è‡ªåŠ¨å»¶é•¿

### **3. ç”Ÿå‘½å‘¨æœŸå¤„ç†**

```
åº”ç”¨è¿›å…¥åŽå° â†’ å¼€å§‹åŽå°ä»»åŠ¡ â†’ ç»§ç»­éŸ³é¢‘å½•åˆ¶
åº”ç”¨è¿”å›žå‰å° â†’ ç»“æŸåŽå°ä»»åŠ¡ â†’ æ­£å¸¸å‰å°å½•åˆ¶
```

## ðŸ” **è°ƒè¯•ä¿¡æ¯**

### **æŽ§åˆ¶å°è¾“å‡º**

åº”ç”¨ä¼šåœ¨æŽ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```
=== åŽå°é…ç½®ä¿¡æ¯ ===
æ”¯æŒçš„åŽå°æ¨¡å¼: ["audio"]
æ”¯æŒéŸ³é¢‘åŽå°: true
å½“å‰åŽå°çŠ¶æ€: åŽå°
å‰©ä½™åŽå°æ—¶é—´: 1.7976931348623157e+308
==================

å¼€å§‹åŽå°æµ‹é‡ä»»åŠ¡ï¼ŒID: 2
åº”ç”¨è¿›å…¥åŽå°
âœ… åº”ç”¨æ”¯æŒæ— é™åŽå°è¿è¡Œï¼ˆéŸ³é¢‘æ¨¡å¼ï¼‰
```

### **çŠ¶æ€ç›‘æŽ§**

- åŽå°ä»»åŠ¡IDè·Ÿè¸ª
- å‰©ä½™æ—¶é—´ç›‘æŽ§
- ä»»åŠ¡å»¶é•¿æ—¥å¿—
- é”™è¯¯å¤„ç†æ—¥å¿—

## ðŸ“‹ **ä½¿ç”¨è¯´æ˜Ž**

### **1. å¯åŠ¨åŽå°å½•åˆ¶**

1. åœ¨ä¸»ç•Œé¢ç‚¹å‡»"å¼€å§‹"æŒ‰é’®
2. åº”ç”¨å¼€å§‹æµ‹é‡å¹¶æ˜¾ç¤ºåˆ†è´å€¼
3. æŒ‰Homeé”®æˆ–åˆ‡æ¢åº”ç”¨
4. åº”ç”¨è‡ªåŠ¨è¿›å…¥åŽå°å½•åˆ¶æ¨¡å¼

### **2. åŽå°çŠ¶æ€ç›‘æŽ§**

- è¿”å›žåº”ç”¨æ—¶å¯ä»¥çœ‹åˆ°"åŽå°è¿è¡Œä¸­"æŒ‡ç¤ºå™¨
- æ˜¾ç¤ºå‰©ä½™åŽå°æ—¶é—´æˆ–"æ— é™"çŠ¶æ€
- æ‰€æœ‰ç»Ÿè®¡æ•°æ®ç»§ç»­æ­£å¸¸æ›´æ–°

### **3. åœæ­¢åŽå°å½•åˆ¶**

- è¿”å›žåº”ç”¨åŽç‚¹å‡»"åœæ­¢"æŒ‰é’®
- åŽå°ä»»åŠ¡è‡ªåŠ¨ç»“æŸ
- åº”ç”¨æ¢å¤æ­£å¸¸å‰å°æ¨¡å¼

## âš ï¸ **æ³¨æ„äº‹é¡¹**

### **1. ç³»ç»Ÿé™åˆ¶**

- **iOSç³»ç»Ÿ**ï¼šåªæœ‰éŸ³é¢‘åŽå°æ¨¡å¼å¯ä»¥æ— é™è¿è¡Œ
- **å…¶ä»–åŽå°æ¨¡å¼**ï¼šé€šå¸¸é™åˆ¶åœ¨30ç§’å†…
- **ç”µæ± ä¼˜åŒ–**ï¼šé•¿æ—¶é—´åŽå°è¿è¡Œå¯èƒ½å½±å“ç”µæ± å¯¿å‘½

### **2. æƒé™è¦æ±‚**

- **éº¦å…‹é£Žæƒé™**ï¼šå¿…é¡»èŽ·å¾—ç”¨æˆ·æŽˆæƒ
- **åŽå°æ¨¡å¼**ï¼šéœ€è¦åœ¨Info.plistä¸­å£°æ˜Ž
- **éŸ³é¢‘ä¼šè¯**ï¼šå¿…é¡»æ­£ç¡®é…ç½®éŸ³é¢‘ä¼šè¯

### **3. æ€§èƒ½è€ƒè™‘**

- **CPUä½¿ç”¨**ï¼šåŽå°éŸ³é¢‘å¤„ç†ä¼šæŒç»­æ¶ˆè€—CPU
- **å†…å­˜ç®¡ç†**ï¼šæ³¨æ„å†…å­˜æ³„æ¼å’Œèµ„æºé‡Šæ”¾
- **ç”µæ± æ¶ˆè€—**ï¼šé•¿æ—¶é—´åŽå°è¿è¡Œä¼šå¢žåŠ ç”µæ± æ¶ˆè€—

## ðŸŽ‰ **åŠŸèƒ½ç‰¹æ€§**

### **âœ… å·²å®žçŽ°åŠŸèƒ½**

- [x] åŽå°éŸ³é¢‘å½•åˆ¶æƒé™é…ç½®
- [x] éŸ³é¢‘ä¼šè¯åŽå°æ”¯æŒ
- [x] åŽå°ä»»åŠ¡è‡ªåŠ¨ç®¡ç†
- [x] åº”ç”¨ç”Ÿå‘½å‘¨æœŸç›‘å¬
- [x] åŽå°çŠ¶æ€UIæ˜¾ç¤º
- [x] è‡ªåŠ¨ä»»åŠ¡å»¶é•¿æœºåˆ¶
- [x] è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### **ðŸ”® æœªæ¥æ‰©å±•**

- [ ] åŽå°å½•åˆ¶æ•°æ®æŒä¹…åŒ–
- [ ] åŽå°å½•åˆ¶åŽ†å²è®°å½•
- [ ] åŽå°å½•åˆ¶é€šçŸ¥æé†’
- [ ] åŽå°å½•åˆ¶è´¨é‡è®¾ç½®
- [ ] åŽå°å½•åˆ¶æš‚åœ/æ¢å¤

## ðŸ“š **æŠ€æœ¯å‚è€ƒ**

### **ç›¸å…³æ¡†æž¶**

- `AVFoundation`ï¼šéŸ³é¢‘å½•åˆ¶å’Œå¤„ç†
- `UIKit`ï¼šåŽå°ä»»åŠ¡ç®¡ç†
- `Combine`ï¼šå“åº”å¼ç¼–ç¨‹
- `SwiftUI`ï¼šç”¨æˆ·ç•Œé¢

### **å…³é”®API**

- `AVAudioSession`ï¼šéŸ³é¢‘ä¼šè¯ç®¡ç†
- `UIBackgroundTaskIdentifier`ï¼šåŽå°ä»»åŠ¡æ ‡è¯†
- `UIApplication.shared.beginBackgroundTask`ï¼šå¼€å§‹åŽå°ä»»åŠ¡
- `NotificationCenter`ï¼šåº”ç”¨ç”Ÿå‘½å‘¨æœŸé€šçŸ¥

---

**æ€»ç»“**ï¼šåº”ç”¨å·²æˆåŠŸå®žçŽ°å®Œæ•´çš„åŽå°å½•åˆ¶åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨åˆ‡æ¢åˆ°åŽå°æ—¶ç»§ç»­æµ‹é‡çŽ¯å¢ƒå™ªå£°ï¼Œæ‰€æœ‰ç»Ÿè®¡æ•°æ®æ­£å¸¸æ›´æ–°ï¼Œå¹¶é€šè¿‡ç›´è§‚çš„UIæŒ‡ç¤ºå™¨æ˜¾ç¤ºåŽå°è¿è¡ŒçŠ¶æ€ã€‚
