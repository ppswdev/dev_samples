# 分贝值分类逻辑说明

## 🎯 修正后的分类规则

### 核心原则
**当前分贝值归类到小于或等于该分贝值的最接近的限值**

### 分类算法
```swift
// 从高到低遍历声级列表，找到第一个小于或等于当前分贝值的限值
for i in stride(from: soundLevels.count - 1, through: 0, by: -1) {
    if level >= soundLevels[i] {
        targetLevel = soundLevels[i]
        break
    }
}
```

---

## 📊 NIOSH标准分类示例

### 限值列表
```
85, 88, 91, 94, 97, 100, 103, 106, 109, 112, 115 dB
```

### 分类规则示例

| 当前分贝值 | 归类到限值 | 说明 |
|-----------|-----------|------|
| 84 dB | 无 | 低于最低限值，不计入 |
| 85 dB | 85 dB | 等于限值 |
| 86 dB | 85 dB | 未超过88，归类到85 |
| 87 dB | 85 dB | 未超过88，归类到85 |
| 88 dB | 88 dB | 等于限值 |
| 89 dB | 88 dB | 未超过91，归类到88 |
| 90 dB | 88 dB | 未超过91，归类到88 |
| 91 dB | 91 dB | 等于限值 |
| 92 dB | 91 dB | 未超过94，归类到91 |
| 93 dB | 91 dB | 未超过94，归类到91 |
| 94 dB | 94 dB | 等于限值 |
| 95 dB | 94 dB | 未超过97，归类到94 |
| 96 dB | 94 dB | 未超过97，归类到94 |
| 97 dB | 97 dB | 等于限值 |
| 98 dB | 97 dB | 未超过100，归类到97 |
| 99 dB | 97 dB | 未超过100，归类到97 |
| 100 dB | 100 dB | 等于限值 |
| 101 dB | 100 dB | 未超过103，归类到100 |
| 102 dB | 100 dB | 未超过103，归类到100 |
| 103 dB | 103 dB | 等于限值 |
| 104 dB | 103 dB | 未超过106，归类到103 |
| 105 dB | 103 dB | 未超过106，归类到103 |
| 106 dB | 106 dB | 等于限值 |
| 107 dB | 106 dB | 未超过109，归类到106 |
| 108 dB | 106 dB | 未超过109，归类到106 |
| 109 dB | 109 dB | 等于限值 |
| 110 dB | 109 dB | 未超过112，归类到109 |
| 111 dB | 109 dB | 未超过112，归类到109 |
| 112 dB | 112 dB | 等于限值 |
| 113 dB | 112 dB | 未超过115，归类到112 |
| 114 dB | 112 dB | 未超过115，归类到112 |
| 115 dB | 115 dB | 等于限值 |
| 116 dB | 115 dB | 超过115，归类到115（天花板限值） |

---

## 🔄 修正前后对比

### 修正前（区间分类）
```
85dB区间：[85, 88) dB  →  85-87dB归类到85
88dB区间：[88, 91) dB  →  88-90dB归类到88
91dB区间：[91, 94) dB  →  91-93dB归类到91
```

### 修正后（最接近限值分类）
```
85dB限值：≤85dB  →  85dB归类到85
88dB限值：85< ≤88dB  →  86-88dB归类到88
91dB限值：88< ≤91dB  →  89-91dB归类到91
```

---

## 💻 代码实现

### 分类函数
```swift
/// 找到分贝值对应的限值
/// - Parameters:
///   - decibelValue: 当前分贝值
///   - soundLevels: 限值列表（已排序）
/// - Returns: 对应的限值，如果没有找到返回nil
func findTargetLevel(for decibelValue: Double, in soundLevels: [Double]) -> Double? {
    // 从高到低遍历声级列表，找到第一个小于或等于当前分贝值的限值
    for i in stride(from: soundLevels.count - 1, through: 0, by: -1) {
        if decibelValue >= soundLevels[i] {
            return soundLevels[i]
        }
    }
    return nil
}
```

### 实际应用示例
```swift
let soundLevels = [85, 88, 91, 94, 97, 100, 103, 106, 109, 112, 115]

// 测试不同的分贝值
let testValues = [84, 85, 87, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116]

for value in testValues {
    if let target = findTargetLevel(for: Double(value), in: soundLevels) {
        print("\(value) dB → 归类到 \(Int(target)) dB")
    } else {
        print("\(value) dB → 无对应限值")
    }
}
```

---

## 📊 实际数据示例

### 假设测量数据
```
测量时间    分贝值    归类到限值
09:00:01    86 dB  →  85 dB
09:00:02    87 dB  →  85 dB
09:00:03    89 dB  →  88 dB
09:00:04    91 dB  →  91 dB
09:00:05    92 dB  →  91 dB
09:00:06    95 dB  →  94 dB
09:00:07    98 dB  →  97 dB
09:00:08    100 dB →  100 dB
09:00:09    102 dB →  100 dB
09:00:10    105 dB →  103 dB
```

### 累计统计结果
```
限值    累计时长(秒)    允许时长    剂量(%)
85 dB   2秒           8小时       0.01%
88 dB   1秒           4小时       0.01%
91 dB   2秒           2小时       0.03%
94 dB   1秒           1小时       0.03%
97 dB   1秒           30分钟      0.06%
100 dB  2秒           15分钟      0.22%
103 dB  1秒           7.5分钟     0.22%
106 dB  0秒           3.75分钟    0.00%
109 dB  0秒           1.875分钟   0.00%
112 dB  0秒           56.25秒     0.00%
115 dB  0秒           28.125秒    0.00%

总剂量: 0.58%
```

---

## 🎯 不同标准的分类示例

### OSHA标准（5dB交换率）
```
限值列表: [90, 95, 100, 105, 110, 115]

分类示例:
92 dB → 90 dB
94 dB → 90 dB
96 dB → 95 dB
98 dB → 95 dB
102 dB → 100 dB
104 dB → 100 dB
```

### GBZ标准（3dB交换率，同NIOSH）
```
限值列表: [85, 88, 91, 94, 97, 100, 103, 106, 109, 112, 115]

分类示例:
87 dB → 85 dB
90 dB → 88 dB
93 dB → 91 dB
96 dB → 94 dB
```

### EU标准（3dB交换率，基准87dB）
```
限值列表: [87, 90, 93, 96, 99, 102, 105, 108, 111, 114]

分类示例:
89 dB → 87 dB
92 dB → 90 dB
95 dB → 93 dB
98 dB → 96 dB
```

---

## ⚠️ 重要说明

### 1. 边界处理
- **低于最低限值**：不计入任何限值统计
- **等于限值**：归类到该限值
- **超过最高限值**：归类到最高限值（天花板限值）

### 2. 算法效率
- 从高到低遍历，找到第一个符合条件的限值即停止
- 时间复杂度：O(n)，其中n为限值数量
- 对于11个限值（NIOSH），最多需要11次比较

### 3. 数据一致性
- 每个分贝值只会归类到一个限值
- 不会出现重复计算或遗漏
- 确保总剂量的准确性

### 4. 实际应用
- 符合职业健康标准的分类要求
- 便于理解和解释
- 与实际测量设备的逻辑一致

---

## 🔗 相关代码

修正后的关键代码位于：
- `DecibelMeterManager.swift` 的 `getPermissibleExposureDurationTable()` 方法
- 第1644-1660行的分类逻辑

---

## ✅ 总结

修正后的分类逻辑更加符合实际应用需求：

1. ✅ **直观性**：87dB归类到85dB，逻辑清晰
2. ✅ **准确性**：每个分贝值只归类到一个限值
3. ✅ **标准性**：符合职业健康标准的分类要求
4. ✅ **一致性**：与其他测量设备的逻辑保持一致

这种分类方式使得允许暴露时长表更加准确和实用！🎯
